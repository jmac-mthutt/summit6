<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Summit 6 Crowd Control Simulator</title>
<style>
  :root{
    --green:#33cc55;--amber:#e6ae37;--red:#d84848;
  }
  body{
    background:#111;color:#fff;font-family:Arial,sans-serif;
    margin:0;padding:0;display:flex;flex-direction:column;align-items:center;
  }
  #wrapper{display:flex;flex-direction:column;align-items:center;width:100%;}
  #sidebar{
    width:90%;max-width:400px;background:#181818;border:2px solid #555;
    padding:10px;border-radius:8px;box-sizing:border-box;
    display:flex;flex-wrap:wrap;justify-content:space-between;font-size:16px;
  }
  #sidebar div{
    width:48%;margin:4px 0;border-bottom:1px solid #333;padding-bottom:3px;
  }
  #stats{
    :90%;max-:400px;background:#202020;border:2px solid #555;
    margin-top:4px;padding:6px;border-radius:8px;text-align:center;
    font-size:18px;
  }
  #gph{font-weight:bold;}
  #timer{font-weight:bold;color:#fff;}
  #goBtn,#restartBtn{
    :90%;max-:500px;margin-top:10px;padding:12px;font-size:18px;
    background:#555;color:#fff;border:1px solid #888;border-radius:6px;cursor:pointer;
  }
  #goBtn:disabled{opacity:0.4;cursor:not-allowed;}
  #restartBtn{display:none;}
  #canvasContainer{
    :100%;display:flex;justify-content:center;align-items:center;
  }
  canvas{
    width:100%;max-width:500px;height:500px;background:#222;border:2px solid #fff;
    touch-action:none;
  }
  #timeUp{
    position:fixed;top:40%;width:100%;text-align:center;font-size:30px;
    color:#fff;text-shadow:0 0 10px #000;display:none;
  }
</style>
</head>
<body>
<h2>Summit 6 Crowd Control Simulator</h2>

<div id="sidebar">
  <div>Singles: <span id="c1">0 seconds</span></div>
  <div>Lane 2: <span id="c2">0 seconds</span></div>
  <div>Lane 3: <span id="c3">0 seconds</span></div>
  <div>Lane 4: <span id="c4">0 seconds</span></div>
</div>

<div id="stats">
  Guests per hour: <span id="gph">0</span><br>
  Time Remaining: <span id="timer">3:00</span><br>
  Score: <span id="score">0 20max</span></div>
</div>

<div id="canvasContainer">
  <canvas id="gameCanvas" width="500" height="500"></canvas>
</div>

<div id="timeUp">⏰ Time's Up!</div>

<!-- buttons at the very bottom -->
<button id="goBtn" disabled>GO</button>
<button id="restartBtn">Restart Game</button>

<script>
// === Canvas / base setup ===
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const HEIGHT=canvas.height, WIDTH=canvas.width;
const GRID_UNIT=40, REVEAL_ZONE_TOP=HEIGHT-3*GRID_UNIT;
const COL_SIZES=[1,3,3,3];
const COL_X=[0,50,200,350];
const TOKEN_COLOR='#41a3ff', BASE_REVEAL_TIME=1500;
let tokensPerSecond=0.5, fallInterval=1000/tokensPerSecond;
let groups=[], selected=[];
const columnHeights=[0,0,0,0];

const goBtn=document.getElementById('goBtn');
const restartBtn=document.getElementById('restartBtn');
const timeUpElem=document.getElementById('timeUp');
const gphElem=document.getElementById('gph');
const timerElem=document.getElementById('timer');
const scoreElem=document.getElementById('score');
const cElems=[c1,c2,c3,c4];

let rowsRemoved,tokensRemovedTotal,startTime,gameOver,score;
const GAME_LIMIT=180000; // 3 minutes

function resetVars(){
  rowsRemoved=[0,0,0,0];
  tokensRemovedTotal=0;
  startTime=performance.now();
  gameOver=false;score=0;
  groups=[];selected=[];
  columnHeights.fill(0);
  goBtn.disabled=true;timeUpElem.style.display='none';restartBtn.style.display='none';
  for(let c of cElems)c.textContent='0 seconds';
  gphElem.textContent='0';gphElem.style.color='#fff';
  timerElem.textContent='03:00';scoreElem.textContent='0';
}
resetVars();

// === Pointer tracking (mouse + touch) ===
let mouseX=-1000,mouseY=-1000;
function processPointer(e){
  const rect=canvas.getBoundingClientRect();
  if(e.touches){mouseX=e.touches[0].clientX-rect.left;mouseY=e.touches[0].clientY-rect.top;}
  else{mouseX=e.clientX-rect.left;mouseY=e.clientY-rect.top;}
}
canvas.addEventListener('mousemove',processPointer);
canvas.addEventListener('touchmove',processPointer);
canvas.addEventListener('mouseleave',()=>{mouseX=-1000;mouseY=-1000;});
canvas.addEventListener('touchend',()=>{mouseX=-1000;mouseY=-1000;});

// === Group class ===
class Group{
  constructor(colIndex,tokenCount,yPos){
    this.colIndex=colIndex;this.tokenCount=tokenCount;
    const cw=COL_SIZES[colIndex];
    this.rows=Math.ceil(tokenCount/cw);
    this.x=COL_X[colIndex];this.y=yPos??(-this.rows*GRID_UNIT);
    this.desiredY=this.y;this.landed=false;this.fallTimer=0;
    this.revealProgress=0;this.revealed=false;
  }
  get bottom(){return this.y+this.rows*GRID_UNIT;}
  update(dt){
    if(!this.landed){
      this.fallTimer+=dt;
      if(this.fallTimer>=fallInterval){
        this.fallTimer=0;
        const projected=this.y+GRID_UNIT;
        const spaceBelow=HEIGHT-columnHeights[this.colIndex]*GRID_UNIT;
        if(projected+this.rows*GRID_UNIT<=spaceBelow)this.y=projected;
        else{
          this.y=HEIGHT-(columnHeights[this.colIndex]+this.rows)*GRID_UNIT;
          columnHeights[this.colIndex]+=this.rows;this.landed=true;this.desiredY=this.y;
        }
      }
    }else{
      const diff=this.desiredY-this.y;
      if(Math.abs(diff)>1)this.y+=diff*0.2;else this.y=this.desiredY;
    }
    const bottom3=this.bottom>REVEAL_ZONE_TOP;
    if(!this.revealed&&bottom3){
      const near=this.isNear();
      if(near){
        const rev=BASE_REVEAL_TIME*(this.tokenCount/6);
        this.revealProgress+=dt/rev;
        if(this.revealProgress>=1)this.revealed=true;
      }else this.revealProgress=Math.max(0,this.revealProgress-0.002*dt);
    }
  }
  isNear(){
    const cw=COL_SIZES[this.colIndex];let rem=this.tokenCount;
    for(let r=0;r<this.rows;r++){
      const rt=rem>=cw?cw:rem;
      for(let i=0;i<rt;i++){
        const x=this.x+i*GRID_UNIT+GRID_UNIT/2;
        const y=this.y+(this.rows-1-r)*GRID_UNIT+GRID_UNIT/2;
        if(Math.hypot(mouseX-x,mouseY-y)<40)return true;
      }rem-=cw;
    }return false;
  }
  draw(){
    const cw=COL_SIZES[this.colIndex];
    const sel=selected.includes(this);
    let rem=this.tokenCount;
    for(let r=0;r<this.rows;r++){
      const rt=rem>=cw?cw:rem;
      for(let i=0;i<rt;i++){
        const x=this.x+i*GRID_UNIT+GRID_UNIT/2;
        const y=this.y+(this.rows-1-r)*GRID_UNIT+GRID_UNIT/2;
        ctx.beginPath();ctx.arc(x,y,GRID_UNIT/2.5,0,Math.PI*2);
        ctx.fillStyle=sel?'yellow':TOKEN_COLOR;ctx.fill();ctx.closePath();
        let a=0.05;const bottom3=this.bottom>REVEAL_ZONE_TOP;
        if(this.revealed)a=1;else if(bottom3&&this.revealProgress>0)a=Math.min(1,this.revealProgress);
        ctx.globalAlpha=a;ctx.fillStyle=sel?'#000':'#fff';
        ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';
        ctx.fillText(this.tokenCount,x,y);ctx.globalAlpha=1;
      }rem-=cw;
    }
  }
}

// === Helpers ===
function randomTokenCount(c){return c===0?1:Math.floor(Math.random()*5)+2;}
function drawGrid(){
  ctx.strokeStyle='#444';
  for(let i=0;i<COL_X.length;i++)ctx.strokeRect(COL_X[i],0,COL_SIZES[i]*GRID_UNIT,HEIGHT);
  ctx.fillStyle='rgba(255,255,255,0.05)';
  ctx.fillRect(0,REVEAL_ZONE_TOP,WIDTH,HEIGHT-REVEAL_ZONE_TOP);
}
function collapseColumn(c){
  const col=groups.filter(g=>g.colIndex===c).sort((a,b)=>a.y-b.y);
  let off=0;
  for(let i=col.length-1;i>=0;i--){const g=col[i];
    g.desiredY=HEIGHT-(off+g.rows)*GRID_UNIT;g.landed=true;off+=g.rows;}
  columnHeights[c]=off;
}
function getClickedGroup(x,y){
  for(let i=groups.length-1;i>=0;i--){
    const g=groups[i];
    if(x>=g.x&&x<=g.x+COL_SIZES[g.colIndex]*GRID_UNIT&&y>=g.y&&y<=g.bottom)return g;
  }return null;
}

// === Selection ===
function selectHandler(x,y){
  if(gameOver)return;
  const g=getClickedGroup(x,y);if(!g)return;
  const already=selected.includes(g);
  if(already)selected=selected.filter(s=>s!==g);else selected.push(g);
  const total=selected.reduce((s,g)=>s+g.tokenCount,0);
  goBtn.disabled=(total!==6);
}
canvas.addEventListener('click',e=>{processPointer(e);selectHandler(mouseX,mouseY);});
canvas.addEventListener('touchend',e=>{processPointer(e);selectHandler(mouseX,mouseY);});

// === GO Button ===
goBtn.addEventListener('click',()=>{
  if(selected.length===0||gameOver)return;
  for(const g of selected){rowsRemoved[g.colIndex]+=g.rows;tokensRemovedTotal+=g.tokenCount;}
  const affected=[...new Set(selected.map(g=>g.colIndex))];
  groups=groups.filter(g=>!selected.includes(g));
  selected=[];affected.forEach(collapseColumn);goBtn.disabled=true;
});

// === Restart Button ===
restartBtn.addEventListener('click',()=>{
  resetVars();
  fillColumnsToTop();
  requestAnimationFrame(gameLoop);
});

// === Progressive speed ===
setInterval(()=>{tokensPerSecond=Math.min(1,tokensPerSecond+0.1);
  fallInterval=1000/tokensPerSecond;},60000);

// === Sidebar / timer / scoring ===
function updateSidebar(){
  const now=performance.now();
  const elapsed=(now-startTime)/1000;
  const remaining=Math.max(0,180-elapsed);
  const mins=Math.floor(remaining/60),secs=Math.floor(remaining%60);
  timerElem.textContent=`${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;

  if(now-startTime>=GAME_LIMIT&&!gameOver){
    gameOver=true;
    goBtn.disabled=true;
    timeUpElem.style.display='block';
    restartBtn.style.display='block';
  }

  const vals=[];
  for(let c=0;c<4;c++){
    const v=rowsRemoved[c]>0?elapsed/rowsRemoved[c]:0;
    vals.push(v);cElems[c].textContent=`${Math.round(v)} seconds`;
  }

  const gph=elapsed>0?Math.round((tokensRemovedTotal/elapsed)*3600):0;
  gphElem.textContent=gph;
  if(gph>2400)gphElem.style.color='var(--green)';
  else if(gph>=2000)gphElem.style.color='var(--amber)';
  else gphElem.style.color='var(--red)';

  const avg=vals.reduce((a,b)=>a+b,0)/vals.length;
  const variance=vals.reduce((a,b)=>a+Math.pow(b-avg,2),0)/vals.length;
  const stdev=Math.sqrt(variance);
  score=stdev>0?(avg/stdev):0;
  scoreElem.textContent=Math.round(score);
}

// === Game loop ===
let last=0;
function gameLoop(t){
  const dt=t-last;last=t;
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  drawGrid();
  groups.forEach(g=>g.update(dt));
  groups.forEach(g=>g.draw());
  updateSidebar();
  if(!gameOver)requestAnimationFrame(gameLoop);
}

// === Start up ===
function fillColumnsToTop(){
  groups=[];columnHeights.fill(0);
  const rowsPerCol=Math.floor(HEIGHT/GRID_UNIT);
  for(let c=0;c<COL_SIZES.length;c++){
    let f=0;
    while(f<rowsPerCol){
      const n=randomTokenCount(c);
      const g=new Group(c,n);
      g.landed=true;g.y=HEIGHT-(f+g.rows)*GRID_UNIT;g.desiredY=g.y;
      groups.push(g);f+=g.rows;
    }columnHeights[c]=f;
  }
}
function spawnGroups(){if(!gameOver){for(let c=0;c<COL_SIZES.length;c++)groups.push(new Group(c,randomTokenCount(c)));}}
fillColumnsToTop();
setInterval(spawnGroups,2500);
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
